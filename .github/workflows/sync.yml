name: Spec Mirror (AI Edition)

on:
  pull_request:
    types: [closed]

jobs:
  ai-audit:
    if: github.event.pull_request.merged == true && github.event.pull_request.milestone != null
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 전체 히스토리 필수

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install -U notion-client google-genai

      - name: Extract Diff to File
        # [Fix] 브랜치 이름 대신 SHA를 직접 비교하여 "PR 내용 그 자체"를 추출
        run: |
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > diff_context.txt
          echo "Diff size: $(wc -c < diff_context.txt) bytes"

      - name: Run Spec Mirror Bot
        env:
          NOTION_KEY: ${{ secrets.NOTION_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PR_MILESTONE_DESC: ${{ github.event.pull_request.milestone.description }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DIFF_FILE_PATH: "diff_context.txt"
        run: python spec_mirror.py