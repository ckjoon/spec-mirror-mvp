name: Spec Mirror (AI Edition)

on:
  pull_request:
    types: [closed] # PR이 머지되거나 닫힐 때

jobs:
  ai-audit:
    # Merged 상태이고, 마일스톤이 설정된 경우에만 실행
    if: github.event.pull_request.merged == true && github.event.pull_request.milestone != null
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Diff를 위해 전체 히스토리 필요

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # 최신 라이브러리 호환성

      - name: Install Dependencies
        run: pip install notion-client google-generativeai

      - name: Extract Diff to File
        # Env Var 대신 파일로 저장 (안전성 확보)
        run: |
          git diff origin/${{ github.base_ref }}...origin/${{ github.head_ref }} > diff_context.txt
          echo "Diff size: $(wc -c < diff_context.txt) bytes"

      - name: Run Spec Mirror Bot
        env:
          NOTION_KEY: ${{ secrets.NOTION_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          # GitHub Context에서 직접 주입
          PR_MILESTONE_DESC: ${{ github.event.pull_request.milestone.description }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DIFF_FILE_PATH: "diff_context.txt"
        run: python spec_mirror.py