name: Spec Mirror (AI Edition)

on:
  pull_request:
    types: [closed]

jobs:
  ai-audit:
    if: github.event.pull_request.merged == true && github.event.pull_request.milestone != null
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        # [Critical] 최신 Unified SDK 설치
        run: pip install -U notion-client google-genai

      - name: Extract Diff to File
        run: |
          git diff origin/${{ github.base_ref }}...origin/${{ github.head_ref }} > diff_context.txt
          echo "Diff size: $(wc -c < diff_context.txt) bytes"

      - name: Run Spec Mirror Bot
        env:
          NOTION_KEY: ${{ secrets.NOTION_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PR_MILESTONE_DESC: ${{ github.event.pull_request.milestone.description }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          DIFF_FILE_PATH: "diff_context.txt"
        run: python spec_mirror.py