name: Spec Mirror (Deep Link Edition)

on:
  pull_request:
    types: [closed]

jobs:
  ai-audit:
    if: github.event.pull_request.merged == true && github.event.pull_request.milestone != null
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install -U notion-client google-genai

      - name: Extract Diff to File
        # SHA 기반의 정확한 Diff 추출
        run: |
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > diff_context.txt
          echo "Diff size: $(wc -c < diff_context.txt) bytes"

      - name: Run Spec Mirror Bot
        env:
          NOTION_KEY: ${{ secrets.NOTION_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PR_MILESTONE_DESC: ${{ github.event.pull_request.milestone.description }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          # [New] 딥링킹(Line Permalink) 생성을 위해 커밋 해시 전달
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          # [New] 리포지토리 이름 (예: owner/repo) 전달
          GITHUB_REPOSITORY: ${{ github.repository }}
          DIFF_FILE_PATH: "diff_context.txt"
        run: python spec_mirror.py